name: Merge Boarding into Train

on:
  pull_request:
    # When a pull request merges, the pull request is automatically closed.
    # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-your-pull_request-workflow-when-a-pull-request-merges
    types: [closed]
    branches:  # ALLOWED Base Branches
      - boarding-auto

jobs:
  merge_rt_in_release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TRAIN: 'release-train'
      RELEASE_BR: 'release'
      BOARDING: ${{ github.event.ref == 'refs/tags/auto-release' && 'boarding-auto' || 'boarding' }}
      MAIN_BR: 'master'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 0 indicates all history for all branches and tags.
          set-safe-directory: ''  # `git config --global --add safe.directory <path>`
          token: '${{ secrets.GH_TOKEN }}'
      
      # Track the remote branches
      - run: git branch --track "${{ env.BOARDING }}" "origin/${{ env.BOARDING }}" || echo "Branch '${{ env.BOARDING }}' already exists"
      - run: git branch --track "${{ env.TRAIN }}" "origin/${{ env.TRAIN }}" || echo "Branch '${{ env.TRAIN }}' already exists"

      ############## PR ##############
      - name: 'Create PR   ${{ env.BOARDING }}  -->  ${{ env.TRAIN }}'
        # --head is the branch where the changes were developed
        # --base is the branch you want to merge the changes into
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh pr create --head "${{ env.BOARDING }}" --base "${{ env.TRAIN }}" \
            --title "Merging '${{ env.BOARDING }}', carrying '${{ steps.user_branch.outputs.USER_BRANCH }}', into '${{ env.TRAIN }}'" \
            --body "## :train: Boarding onto the Release Train :train:

          This PR is automatically generated by a GitHub Action workflow. It's part of the process of boarding changes onto the **Release Train** branch, setting the stage for the next steps in our GitOps journey.

          ### What's Happening Here?

          - We're merging changes from `${{ steps.user_branch.outputs.USER_BRANCH }}` into the `${{ env.TRAIN }}` branch.
          - This is a critical step in our process, moving us closer to launching the Release Train.

          ### Next Steps: Launching and Opening the Doors

          - Once this PR is merged, we're set to **launch the Release Train**.
          - After the launch, our next goal is to **open the doors** of the Release Train, making these changes available in our release.

          ### :white_check_mark: Automatic Merging :white_check_mark:

          - This PR is designed to **automatically merge** once all CI checks pass.
          - The CI checks include our GitHub Actions workflows and RTD integration.

          ### :warning: A Note to Maintainers :warning:

          - Please **do not close this PR manually**.
          - If there are any issues or required manual interventions, reach out to the development team.
          "

      ############## Merge ##############
      - name: 'Merge PR   ${{ env.BOARDING }}  -->  ${{ env.TRAIN }}'
        run: gh pr merge "${{ env.BOARDING }}" --auto
        # --delete-branch --squash
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        # HEAD is now at ${{ env.TRAIN }}
